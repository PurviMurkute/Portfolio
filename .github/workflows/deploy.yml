name: Staging Deployment

env:
  BUCKET_NAME: purvimurkute.in
  DISTRIBUTION_ID: E3B2WUEYPOR257
  BUILD_DIR: dist

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --legacy-peer-deps

    - name: Build React app
      run: npm run build:staging

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
        aws-region: ap-south-1

    - name: Push build to S3 bucket
      run: |
        aws s3 sync $BUILD_DIR s3://$BUCKET_NAME --delete

    - name: Create CloudFront invalidation
      run: |
        aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"